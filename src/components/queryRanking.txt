WITH distances AS (
    SELECT 
        a.id AS apartment_id,
        s.id AS supermarket_id,
        ST_DistanceSphere(
            ST_MakePoint(a.longitude, a.latitude),
            ST_MakePoint(s.longitude, s.latitude)
        ) AS distance
    FROM apartments a
    CROSS JOIN supermarkets s
),
apartment_rankings AS (
    SELECT
        apartment_id,
        SUM(
            CASE
                WHEN $1 = 0 THEN 0
                WHEN $1 = 1 THEN LEAST(1 / (distance + 1), 5)
                WHEN $1 = 2 THEN LEAST(1 / (distance + 1) * 2, 5)
                WHEN $1 = 3 THEN LEAST(1 / (distance + 1) * 3, 5)
                WHEN $1 = 4 THEN LEAST(1 / (distance + 1) * 4, 5)
                WHEN $1 = 5 THEN LEAST(1 / (distance + 1) * 5, 5)
            END
        ) AS rank_score
    FROM distances
    GROUP BY apartment_id
)
SELECT
    a.id,
    a.latitude,
    a.longitude,
    ar.rank_score
FROM apartments a
JOIN apartment_rankings ar ON a.id = ar.apartment_id
ORDER BY ar.rank_score DESC;
